<!-- success.html — Halaman Pembayaran Berhasil -->
<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pembayaran Berhasil</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--text:#1f2330;--muted:#6b7280;--line:#e9eaf0;
    --primary:#8f67e8;--success:#10b981;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .container{max-width:980px;margin:0 auto;padding:16px}
  header{background:linear-gradient(90deg,#8a63d2,#b07cfb);color:#fff}
  .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand-badge{width:28px;height:28px;border-radius:8px;background:#fff;color:#8a63d2;display:grid;place-items:center;font-weight:900}
  main{padding:24px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:28px;box-shadow:0 2px 22px rgba(0,0,0,.05)}
  .center{text-align:center}
  .bigIcon{
    width:140px;height:140px;border-radius:999px;background:rgba(16,185,129,.15);
    display:grid;place-items:center;margin:14px auto 10px auto
  }
  .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--line)}
  .row:last-child{border-bottom:0}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="nav container">
    <div class="brand"><div class="brand-badge">E</div> EPIM 2025</div>
    <div class="small">Pembayaran</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="center">
      <h2 style="margin:0">Selamat! Pembayaran Berhasil</h2>
      <div class="small">Terima kasih sudah berlangganan tiket di Festival Enem</div>
      <div class="bigIcon" aria-hidden="true">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" fill="var(--success)"/>
          <path d="M7 12.5l3 3 7-7" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div id="details"></div>

    <div class="actions">
      <button class="btn" id="openInvoice">Lihat Invoice</button>
      <button class="btn primary" id="downloadTicket">Unduh Tiket</button>
    </div>
  </section>
</main>

<script>
  const rupiah = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n).replace(",00","");
  const order = JSON.parse(localStorage.getItem('order')||'null');
  if(!order){ location.href='pay.html'; }

  // Force status to paid in case user arriving from external redirect
  order.status='paid'; localStorage.setItem('order', JSON.stringify(order));

  // Render breakdown
  let subtotal=order.items.reduce((a,b)=>a+b.qty*b.price,0);
  const total=subtotal+order.tax+order.fee;
  const el=document.getElementById('details');
  el.innerHTML=`
    <div style="border-top:1px dashed #e9eaf0;margin:8px 0 10px 0"></div>
    ${order.items.map(it=>`
      <div class="row"><div>${it.name} ${it.qty>1?('x'+it.qty):''}</div><div>${rupiah(it.qty*it.price)}</div></div>
    `).join('')}
    <div class="row"><div>Local Tax</div><div>${rupiah(order.tax)}</div></div>
    <div class="row"><div>Biaya Platform</div><div>${rupiah(order.fee)}</div></div>
    <div class="row" style="font-weight:800"><div>Total Keseluruhan</div><div>${rupiah(total)}</div></div>
    <div class="small">No. Pesanan ${order.id} • Metode ${order.method}</div>
  `;

  document.getElementById('openInvoice').onclick=()=>location.href='invoice.html';

  // Generate simple e-ticket PNG (QR + teks) without dependencies
  document.getElementById('downloadTicket').onclick=()=>{
    const w=720,h=360;
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d');
    // bg
    const g=ctx.createLinearGradient(0,0,w,0); g.addColorStop(0,'#8a63d2'); g.addColorStop(1,'#b07cfb');
    ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#fff'; ctx.fillRect(18,18,w-36,h-36);
    // title
    ctx.fillStyle='#1f2330'; ctx.font='700 28px system-ui,Arial'; ctx.fillText('E-Ticket', 40, 60);
    ctx.font='16px system-ui,Arial'; ctx.fillStyle='#6b7280';
    ctx.fillText(order.event, 40, 90);
    ctx.fillText(order.date, 40, 115);
    // QR area
    const qrSize = 220; const qrX = w-40-qrSize; const qrY = 60;
    // draw simple QR-like pattern
    function drawFakeQR(ctx,x,y,size,seedStr){
      let h=2166136261>>>0; for(let i=0;i<seedStr.length;i++){h^=seedStr.charCodeAt(i); h=Math.imul(h,16777619);} let s=h>>>0;
      const rand=()=> (s=(s*1664525+1013904223)>>>0)/0x100000000;
      const modules=33; const cell=Math.floor(size/modules);
      ctx.fillStyle='#fff'; ctx.fillRect(x,y,size,size);
      ctx.fillStyle='#000';
      function finder(ix,iy){
        ctx.fillRect(x+ix*cell,y+iy*cell,7*cell,7*cell);
        ctx.fillStyle='#fff'; ctx.fillRect(x+ix*cell+cell,y+iy*cell+cell,5*cell,5*cell);
        ctx.fillStyle='#000'; ctx.fillRect(x+ix*cell+2*cell,y+iy*cell+2*cell,3*cell,3*cell);
      }
      finder(2,2); finder(modules-9,2); finder(2,modules-9);
      for(let r=0;r<modules;r++){
        for(let c=0;c<modules;c++){
          const inFinder=(r>=2&&r<9&&c>=2&&c<9)||(r>=2&&r<9&&c>=modules-9&&c<modules-2)||(r>=modules-9&&r<modules-2&&c>=2&&c<9);
          const quiet=(r<1||c<1||r>=modules-1||c>=modules-1);
          if(inFinder||quiet) continue;
          if(rand()<0.45) ctx.fillRect(x+c*cell,y+r*cell,cell,cell);
        }
      }
    }
    drawFakeQR(ctx, qrX, qrY, qrSize, order.id+'-'+order.method);
    // text right
    ctx.fillStyle='#1f2330'; ctx.font='700 18px system-ui,Arial';
    ctx.fillText('Order '+order.id, 40, 160);
    ctx.font='16px system-ui,Arial';
    let y=190;
    order.items.forEach(it=>{
      ctx.fillText(`- ${it.name} x${it.qty}`, 40, y); y+=22;
    });
    ctx.fillText('Total: '+(new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(order.items.reduce((a,b)=>a+b.qty*b.price,0)+order.tax+order.fee)).replace(",00",""), 40, y+10);
    // footer
    ctx.fillStyle='#6b7280'; ctx.font='12px system-ui,Arial'; ctx.fillText('Metode: '+order.method+' • Terbit: '+new Date().toLocaleString('id-ID'), 40, h-30);
    const a=document.createElement('a'); a.download=`E-Ticket-${order.id}.png`; a.href=c.toDataURL('image/png'); a.click();
  };
</script>
</body>
</html>